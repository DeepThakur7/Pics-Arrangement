<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pic → Excel (3 per row + notes, compressed, mobile-friendly)</title>
  <style>
    :root { --accent:#0067b8; --bg:#f6f8fb; --border:#d0d4da; }
    body { font-family: Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:#222; }
    header { padding:12px 16px; background:#fff; border-bottom:1px solid var(--border); }
    h1 { font-size:18px; margin:0 0 4px 0; }
    .subtitle{ font-size:12px; color:#555; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; padding:12px; }
    @media (min-width:900px){ .grid{ grid-template-columns: 340px 1fr; } }
    .card { background:#fff; border:1px solid var(--border); border-radius:8px; padding:12px; }
    .card h2 { font-size:14px; margin:0 0 8px 0; }
    .field { margin:8px 0; }
    .label { font-size:12px; color:#555; display:block; margin-bottom:4px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="number"]{ width:100px; padding:6px; }
    input[type="text"]{ padding:6px; width:220px; }
    input[type="color"]{ width:44px; height:28px; padding:0; }
    .btn { background: var(--accent); color:#fff; border:none; border-radius:6px; padding:10px 14px; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.secondary{ background:#444; }
    .bar { display:flex; gap:8px; flex-wrap:wrap; }
    .muted { color:#666; font-size:12px; }
    #dropzone { border:2px dashed var(--border); border-radius:8px; background:#fff; padding:16px; text-align:center; color:#666; }
    #dropzone.dragover{ background:#eef6ff; border-color:#99c4f2; color:#2c5a90; }
    #gallery { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; }
    .thumb { border:1px solid var(--border); border-radius:8px; padding:6px; background:#fff; }
    .thumb img { width:100%; height:120px; object-fit:cover; border-radius:4px; }
    .thumb .meta { font-size:11px; margin-top:6px; display:flex; justify-content:space-between; align-items:center; }
    .thumb .remove { font-size:11px; color:#a00; cursor:pointer; }
    #status { font-size:12px; color:#333; }
    #status .ok{ color: #047857; }
    #status .bad{ color: #b91c1c; }
    .tip { font-size:12px; color:#555; margin-top:6px; }
  </style>
  <!-- ExcelJS via CDN + fallback -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js" defer></script>
  <script>
    (function ensureExcelJS(){
      function loadLocal(){ var s=document.createElement('script'); s.src='exceljs.min.js'; document.head.appendChild(s); }
      window.addEventListener('load', function(){ if(!window.ExcelJS){ loadLocal(); } });
    })();
  </script>
</head>
<body>
  <header>
    <h1>Export Images to Excel — 3 per row + notes (compressed, mobile‑friendly)</h1>
    <div class="subtitle">Works on mobile: select multiple from Photos or Files; compress before export to reduce .xlsx size.</div>
  </header>

  <div class="grid">
    <div class="card">
      <h2>Layout & Compression</h2>
      <div class="field">
        <span class="label">Unit</span>
        <label><input type="radio" name="unit" value="cm" checked> cm</label>
        <label style="margin-left:8px"><input type="radio" name="unit" value="px"> px</label>
      </div>
      <div class="row field">
        <div>
          <span class="label">Picture width</span>
          <input id="picW" type="number" min="1" step="0.1" value="6">
        </div>
        <div>
          <span class="label">Picture height</span>
          <input id="picH" type="number" min="1" step="0.1" value="6">
        </div>
      </div>
      <div class="row field">
        <div>
          <span class="label">Resize mode</span>
          <label><input type="radio" name="resizeMode" value="fit" checked> Fit (no crop)</label>
          <label style="margin-left:8px"><input type="radio" name="resizeMode" value="fill"> Fill (crop)</label>
        </div>
      </div>
      <div class="row field">
        <div>
          <span class="label">JPEG quality (0.3 – 0.95)</span>
          <input id="jpegQ" type="number" min="0.3" max="0.95" step="0.05" value="0.70">
        </div>
        <div>
          <span class="label">Convert PNG/WebP to JPEG</span>
          <label><input id="forceJpeg" type="checkbox" checked> Recommended</label>
        </div>
        <div>
          <span class="label">Preserve transparency (PNG)</span>
          <label><input id="preserveAlpha" type="checkbox"> Use PNG (larger)</label>
        </div>
        <div>
          <span class="label">Background color (when alpha not preserved)</span>
          <input id="bgColor" type="color" value="#ffffff">
        </div>
      </div>
      <div class="row field">
        <div>
          <span class="label">Notes row height (cm)</span>
          <input id="notesH" type="number" min="0.5" step="0.1" value="2.0">
        </div>
        <div>
          <span class="label">Excel file name</span>
          <input id="xlsxName" type="text" value="images.xlsx">
        </div>
      </div>
      <div class="field">
        <span class="label">Actions</span>
        <div class="bar">
          <button class="btn" id="selectBtn" type="button">Select images</button>
          <button class="btn secondary" id="clearBtn" type="button">Clear</button>
          <button class="btn" id="downloadXlsxBtn" type="button">Download .xlsx</button>
        </div>
        <div id="status" class="muted" style="margin-top:8px">
          ExcelJS: <span id="excelStatus" class="bad">not loaded</span> · Files: <span id="fileCount">0</span> · Est. total after compression: <span id="estTotal">0 KB</span>
        </div>
        <div class="tip">Mobile tip: on iPhone Photos, tap <b>Select</b> to choose multiple; or use the <b>Files</b> picker to multi‑select.</div>
      </div>
      <!-- Two inputs: hidden primary + visible fallback for mobile Safari -->
      <input id="fileHidden" type="file" accept="image/*" multiple style="display:none" />
      <input id="fileVisible" type="file" accept="image/*" multiple style="display:none" />
    </div>

    <div class="card">
      <h2>Images</h2>
      <div id="dropzone">Drag & drop images here</div>
      <div id="gallery" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    // --- Helpers
    const CM_TO_PX = 96 / 2.54; // 96dpi assumption
    const PX_TO_POINTS = 72 / 96; // Excel row heights are in points
    const toPx = (val, unit) => unit === 'cm' ? (parseFloat(val||0) * CM_TO_PX) : parseFloat(val||0);
    const toPointsFromPx = (px) => px * PX_TO_POINTS;
    const pixelsToExcelChars = (px) => Math.max(1, (px - 5) / 7);

    const filesState = []; window.filesState = filesState;

    function updateStatus(){
      const excelOk = !!window.ExcelJS;
      document.getElementById('excelStatus').textContent = excelOk ? 'loaded' : 'not loaded';
      document.getElementById('excelStatus').className = excelOk ? 'ok' : 'bad';
      document.getElementById('fileCount').textContent = String(filesState.length);
    }
    function setEstTotal(bytes){
      const kb = Math.round(bytes/1024);
      document.getElementById('estTotal').textContent = kb + ' KB';
    }

    // Ensure attributes for mobile multi-select
    function ensureMobileAttrs(el){
      if (!el) return;
      el.setAttribute('accept','image/*');
      el.setAttribute('multiple','');
      // Avoid forcing camera-only flow on mobile; keep it a gallery/files picker
      el.removeAttribute('capture');
    }

    const hiddenInput = document.getElementById('fileHidden');
    const visibleInput = document.getElementById('fileVisible');
    ensureMobileAttrs(hiddenInput); ensureMobileAttrs(visibleInput);

    function appendFiles(list){
      Array.from(list||[]).forEach(f=>{ if (f && (f.type||'').startsWith('image/')) filesState.push(f); });
    }

    function handleChange(e){
      const files = Array.from(e.target.files||[]).filter(f=>f.type.startsWith('image/'));
      addCards(files);
      updateStatus();
      estimateCompressedTotal().catch(()=>{});
    }

    hiddenInput.addEventListener('change', handleChange);
    visibleInput.addEventListener('change', handleChange);

    document.getElementById('selectBtn').addEventListener('click', function(){
      try { if (hiddenInput.showPicker) hiddenInput.showPicker(); } catch(e) {}
      try { hiddenInput.click(); }
      catch(e){
        // iOS Safari sometimes blocks programmatic click on hidden inputs
        visibleInput.style.display = 'block';
        visibleInput.click();
        // Hide again after interaction
        setTimeout(()=>{ visibleInput.style.display='none'; }, 2000);
      }
    });

    // Drag & drop
    const dropzone = document.getElementById('dropzone');
    ['dragenter','dragover'].forEach(evt=> dropzone.addEventListener(evt, (e)=>{ e.preventDefault(); dropzone.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(evt=> dropzone.addEventListener(evt, (e)=>{ e.preventDefault(); dropzone.classList.remove('dragover'); }));
    dropzone.addEventListener('drop', (e)=>{
      const files = Array.from(e.dataTransfer.files||[]).filter(f=>f.type.startsWith('image/'));
      addCards(files);
      updateStatus();
      estimateCompressedTotal().catch(()=>{});
    });

    // Clear
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      filesState.splice(0, filesState.length);
      document.getElementById('gallery').innerHTML = '';
      setEstTotal(0);
      updateStatus();
    });

    // Gallery
    function addCards(files){
      const gallery = document.getElementById('gallery');
      files.forEach(file=>{
        filesState.push(file);
        const url = URL.createObjectURL(file);
        const div = document.createElement('div'); div.className='thumb';
        div.innerHTML = `<img src="${url}" alt="${file.name}"><div class="meta"><span>${file.name}</span><span class="remove">Remove</span></div>`;
        div.querySelector('.remove').addEventListener('click', ()=>{
          const i = filesState.indexOf(file); if(i>-1) filesState.splice(i,1);
          URL.revokeObjectURL(url); div.remove(); updateStatus(); estimateCompressedTotal().catch(()=>{});
        });
        gallery.appendChild(div);
      });
    }

    // Canvas compression
    function processToCanvas(img, targetW, targetH, mode){
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(targetW);
      canvas.height = Math.round(targetH);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const sw = img.naturalWidth, sh = img.naturalHeight; const sr = sw/sh; const dr = targetW/targetH;
      let dw, dh, dx, dy;
      if (mode === 'fill'){
        if (sr > dr){ dh = targetH; dw = dh * sr; } else { dw = targetW; dh = dw / sr; }
        dx = (targetW - dw)/2; dy = (targetH - dh)/2;
      } else {
        if (sr > dr){ dw = targetW; dh = dw / sr; dx = 0; dy = (targetH - dh)/2; }
        else { dh = targetH; dw = dh * sr; dx = (targetW - dw)/2; dy = 0; }
      }
      ctx.drawImage(img, dx, dy, dw, dh);
      return canvas;
    }

    async function fileToCompressedDataURL(file, targetW, targetH, opts){
      const { mode, jpegQ, forceJpeg, preserveAlpha, bgColor } = opts;
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = () => {
          const canvas = processToCanvas(img, targetW, targetH, mode);
          const ctx = canvas.getContext('2d');
          let mime = 'image/jpeg'; let quality = Math.min(Math.max(jpegQ||0.7, 0.3), 0.95);
          const type = (file.type||'').toLowerCase();
          const wantsPng = preserveAlpha && /png|webp/.test(type) && !forceJpeg;
          if (wantsPng){
            mime = 'image/png'; quality = undefined;
          } else {
            ctx.globalCompositeOperation = 'destination-over';
            ctx.fillStyle = bgColor || '#ffffff';
            ctx.fillRect(0,0,canvas.width,canvas.height);
          }
          const dataUrl = canvas.toDataURL(mime, quality);
          resolve({ dataUrl, width: canvas.width, height: canvas.height, mime });
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    async function estimateCompressedTotal(){
      const unit = document.querySelector("input[name='unit']:checked").value;
      const targetW = toPx(document.getElementById('picW').value, unit);
      const targetH = toPx(document.getElementById('picH').value, unit);
      const mode = document.querySelector("input[name='resizeMode']:checked").value;
      const jpegQ = parseFloat(document.getElementById('jpegQ').value||'0.7');
      const forceJpeg = document.getElementById('forceJpeg').checked;
      const preserveAlpha = document.getElementById('preserveAlpha').checked;
      const bgColor = document.getElementById('bgColor').value;
      let total = 0;
      for (const f of filesState){
        try{
          const {dataUrl} = await fileToCompressedDataURL(f, targetW, targetH, {mode,jpegQ,forceJpeg,preserveAlpha,bgColor});
          total += Math.round((dataUrl.length * 3)/4);
        }catch{}
      }
      setEstTotal(total);
      return total;
    }

    // Build Excel: 3 images per row + notes row beneath, with compression
    document.getElementById('downloadXlsxBtn').addEventListener('click', async function(){
      try {
        updateStatus();
        for (let i=0; i<15 && !window.ExcelJS; i++) { await new Promise(r=>setTimeout(r,100)); }
        if (!window.ExcelJS){ alert('ExcelJS not loaded. Place exceljs.min.js next to this HTML or allow CDN.'); return; }
        if (!filesState.length){ alert('No images selected.'); return; }
        
        const unit = document.querySelector("input[name='unit']:checked").value;
        const targetW = toPx(document.getElementById('picW').value, unit);
        const targetH = toPx(document.getElementById('picH').value, unit);
        const mode = document.querySelector("input[name='resizeMode']:checked").value;
        const jpegQ = parseFloat(document.getElementById('jpegQ').value||'0.7');
        const forceJpeg = document.getElementById('forceJpeg').checked;
        const preserveAlpha = document.getElementById('preserveAlpha').checked;
        const bgColor = document.getElementById('bgColor').value;
        const notesHeightCm = parseFloat(document.getElementById('notesH').value||'2');
        const notesHeightPts = toPointsFromPx(notesHeightCm * CM_TO_PX);
        const colWidthChars = pixelsToExcelChars(targetW);
        const xlsxName = (document.getElementById('xlsxName').value||'images.xlsx').trim();

        const wb = new ExcelJS.Workbook();
        wb.creator = 'Pic → Excel (Compressed, Mobile)'; wb.created = new Date();
        const ws = wb.addWorksheet('Pics');
        ws.columns = [ { key:'c1', width: colWidthChars }, { key:'c2', width: colWidthChars }, { key:'c3', width: colWidthChars } ];

        const imagesData = [];
        for (const file of filesState){
          const processed = await fileToCompressedDataURL(file, targetW, targetH, {mode, jpegQ, forceJpeg, preserveAlpha, bgColor});
          const ext = /png/.test(processed.mime) ? 'png' : 'jpeg';
          const imgId = wb.addImage({ base64: processed.dataUrl, extension: ext });
          imagesData.push({ id: imgId, width: processed.width, height: processed.height });
        }

        let currentRow = 1;
        const imgRowHeightPts = toPointsFromPx(targetH);
        const groups = [];
        for (let i=0; i<imagesData.length; i+=3){ groups.push(imagesData.slice(i, i+3)); }

        groups.forEach(group => {
          ws.getRow(currentRow).height = imgRowHeightPts;
          ws.getRow(currentRow+1).height = notesHeightPts;
          group.forEach((img, idx)=>{
            ws.addImage(img.id, { tl: { col: idx, row: currentRow-1 }, ext: { width: Math.round(targetW), height: Math.round(targetH) } });
          });
          ws.mergeCells(currentRow+1, 1, currentRow+1, 3);
          const cell = ws.getCell(currentRow+1, 1);
          cell.value = 'Notes:'; cell.alignment = { vertical:'top' };
          cell.border = { top:{style:'thin', color:{argb:'FFBFBFBF'}}, left:{style:'thin', color:{argb:'FFBFBFBF'}}, right:{style:'thin', color:{argb:'FFBFBFBF'}}, bottom:{style:'thin', color:{argb:'FFBFBFBF'}} };
          currentRow += 2;
        });

        ws.views = [{ showGridLines: true }];

        const buffer = await wb.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.style.display='none'; a.href = url; a.download = xlsxName || 'images.xlsx';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
      } catch(err) {
        console.error(err);
        alert('Failed to generate .xlsx: ' + (err && err.message ? err.message : err));
      }
    });

    // Initial status
    updateStatus();
    window.addEventListener('load', updateStatus);
  </script>
</body>
</html>
